{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
.filtros-container {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    border: 1px solid #dee2e6;
}

.filtro-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}

.resultados-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.status-badge-recuperado {
    font-size: 0.8em;
    padding: 4px 8px;
}

.btn-timeline {
    padding: 5px 10px;
    font-size: 0.8em;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 9999;
}

.loading-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-search me-2"></i>
                Pesquisa de CCOs
            </h2>
            <p class="text-muted">Pesquise CCOs por ID ou aplicando filtros específicos</p>
        </div>
    </div>

    <!-- Filtros de Pesquisa -->
    <div class="filtros-container">
        <h5><i class="fas fa-filter me-2"></i>Filtros de Pesquisa</h5>
        
        <!-- Pesquisa por ID -->
        <div class="filtro-section">
            <h6><i class="fas fa-hashtag me-2"></i>Pesquisa por ID</h6>
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="form-control" id="inputId" placeholder="Digite o ID da CCO">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="pesquisarPorId()">
                        <i class="fas fa-search me-1"></i>Pesquisar por ID
                    </button>
                </div>
            </div>
        </div>

        <div class="text-center my-3">
            <strong>OU</strong>
        </div>

        <!-- Pesquisa por Filtros -->
        <div class="filtro-section">
            <h6><i class="fas fa-sliders-h me-2"></i>Pesquisa por Filtros</h6>
            <form id="formFiltros">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Contrato CPP *</label>
                        <select class="form-select" id="selectContrato" required onchange="carregarCampos()">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Campo</label>
                        <select class="form-select" id="selectCampo">
                            <option value="">Todos</option>
                        </select>
                        
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Remessa</label>
                        <input type="number" class="form-control" id="inputRemessa" placeholder="Número">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Exercício</label>
                        <input type="number" class="form-control" id="inputExercicio" placeholder="AAAA">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Período</label>
                        <input type="number" class="form-control" id="inputPeriodo" placeholder="MM" min="1" max="12">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Fase Remessa</label>
                        <select class="form-select" id="selectFase">
                            <option value="">Todas</option>
                            <option value="MEN">MEN</option>
                            <option value="ROP">ROP</option>
                            <option value="RAD">RAD</option>
                            <option value="REC">REC</option>
                            <option value="REV">REV</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Origem dos Gastos</label>
                        <select class="form-select" id="selectOrigem">
                            <option value="">Todas</option>
                            <option value="GASTO_EXCLUSIVO">Gasto Exclusivo</option>
                            <option value="GASTO_JAZIDA_COMPARTILHADA">Gasto Jazida Compartilhada</option>
                            <option value="GASTO_ATIVO_COMPARTILHADO">Gasto Ativo Compartilhado</option>
                            <option value="GASTO_AEGV">Gasto AEGV</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-success w-100" onclick="pesquisarPorFiltros()">
                            <i class="fas fa-search me-1"></i>Pesquisar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Resultados -->
    <div id="containerResultados" class="resultados-container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-list me-2"></i>Resultados da Pesquisa</h5>
            <span id="totalResultados" class="badge bg-primary"></span>
        </div>
        
        <div class="table-responsive">
            <table id="tabelaCCOs" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Ações</th>
                        <th>ID</th>
                        <th>Contrato</th>
                        <th>Campo</th>
                        <th>Remessa</th>
                        <th>Fase</th>
                        <th>Ano/Mes Rec.</th>
                        <th>Período</th>
                        <th>Origem</th>
                        <th>Recuperado</th>
                        <th>Correções</th>
                        <th>Última Atualização</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h5>Pesquisando CCOs...</h5>
        <p class="text-muted">Por favor, aguarde</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarContratos();
    
});

function carregarContratos() {
    fetch('/api/contratos-disponiveis')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('selectContrato');
            select.innerHTML = '<option value="">Selecione...</option>';
            data.contratos.forEach(contrato => {
                select.innerHTML += `<option value="${contrato}">${contrato}</option>`;
            });
        })
        .catch(error => console.error('Erro ao carregar contratos:', error));
}

function carregarCampos() {
    const contrato = document.getElementById('selectContrato').value;
    const selectCampo = document.getElementById('selectCampo');

    console.log(contrato);
    
    if (!contrato) {
        selectCampo.innerHTML = '<option value="">Todos</option>';
        return;
    }
    
    fetch(`/api/campos-por-contrato/${contrato}`)
        .then(response => response.json())
        .then(data => {
            selectCampo.innerHTML = '<option value="">Todos</option>';
            data.campos.forEach(campo => {
                selectCampo.innerHTML += `<option value="${campo}">${campo}</option>`;
                console.log(campo);
            });
        })
        .catch(error => console.error('Erro ao carregar campos:', error));
}

function pesquisarPorId() {
    const id = document.getElementById('inputId').value.trim();
    
    if (!id) {
        alert('Por favor, digite um ID para pesquisa');
        return;
    }
    
    const dados = { id: id };
    executarPesquisa(dados);
}

function pesquisarPorFiltros() {
    const contrato = document.getElementById('selectContrato').value;
    
    if (!contrato) {
        alert('Contrato CPP é obrigatório para pesquisa por filtros');
        return;
    }
    
    const dados = {
        contratoCpp: contrato,
        campo: document.getElementById('selectCampo').value,
        remessa: document.getElementById('inputRemessa').value,
        exercicio: document.getElementById('inputExercicio').value,
        periodo: document.getElementById('inputPeriodo').value,
        faseRemessa: document.getElementById('selectFase').value,
        origemDosGastos: document.getElementById('selectOrigem').value
    };
    
    
    
    executarPesquisa(dados);
}

function executarPesquisa(dados) {
    mostrarLoading();
    
    fetch('/api/pesquisar-ccos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        esconderLoading();
        
        if (data.success) {
            exibirResultados(data.resultados, data.total);
        } else {
            alert('Erro na pesquisa: ' + data.error);
        }
    })
    .catch(error => {
        esconderLoading();
        console.error('Erro na pesquisa:', error);
        alert('Erro ao executar pesquisa');
    });
}

function exibirResultados(resultados, total) {
    const container = document.getElementById('containerResultados');
    const totalSpan = document.getElementById('totalResultados');
    const tbody = document.querySelector('#tabelaCCOs tbody');
    
    totalSpan.textContent = `${total} resultado(s)`;
    tbody.innerHTML = '';
    //<td><strong>R$ ${cco.valorReconhecido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
    //<td><strong>R$ ${cco.valorReconhecidoComOH.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
             
    resultados.forEach(cco => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <button class="btn btn-primary btn-timeline" onclick="abrirTimeline('${cco.id}')">
                    <i class="fas fa-history me-1"></i>Timeline
                </button>
            </td>
            <td><code style="font-size: 0.8em;">${cco.id}</code></td>
            <td>${cco.contratoCpp}</td>
            <td>${cco.campo}</td>
            <td><span class="badge bg-info">${cco.remessa}</span></td>
            <td><span class="badge bg-secondary">${cco.faseRemessa}</span></td>
            <td>${cco.mesReconhecimento}/${cco.anoReconhecimento}</td>
            <td>${cco.periodo}</td>
            <td><small>${cco.origemDosGastos}</small></td>
            <td>
                <span class="status-badge-recuperado badge ${cco.flgRecuperado ? 'bg-success' : 'bg-secondary'}">
                    ${cco.flgRecuperado ? 'Sim' : 'Não'}
                </span>
            </td>
            <td>
                <span class="badge ${cco.temCorrecoes ? 'bg-warning' : 'bg-light text-dark'}">
                    ${cco.temCorrecoes ? 'Sim' : 'Não'}
                </span>
            </td>
            <td><small>${cco.ultimaAtualizacao}</small></td>
        `;
        tbody.appendChild(tr);
    });
    
    container.style.display = 'block';
    
    // Inicializar DataTable se ainda não foi inicializado
    if (!$.fn.DataTable.isDataTable('#tabelaCCOs')) {
        $('#tabelaCCOs').DataTable({
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json'
            },
            pageLength: 25,
            scrollX: true,
            order: [[4, 'desc']], // Ordenar por remessa decrescente
            columnDefs: [
                { targets: 0, orderable: false }, // Coluna de ações
                { targets: [9, 10], className: 'text-end' } // Colunas de valores
            ]
        });
    } else {
        $('#tabelaCCOs').DataTable().clear().rows.add(tbody.querySelectorAll('tr')).draw();
    }
}

function abrirTimeline(ccoId) {
    window.open(`/cco-timeline/${ccoId}`, '_blank');
}

function mostrarLoading() {
    document.getElementById('loadingOverlay').style.display = 'block';
}

function esconderLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}
</script>
{% endblock %}